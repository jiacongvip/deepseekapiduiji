# è±†åŒ…APIä»£ç†æœåŠ¡å®ç°åŸç†è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
3. [æ ¸å¿ƒå®ç°åŸç†](#æ ¸å¿ƒå®ç°åŸç†)
4. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)
5. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
6. [ä»£ç ç»“æ„åˆ†æ](#ä»£ç ç»“æ„åˆ†æ)

---

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**è½»é‡çº§è±†åŒ…APIä»£ç†æœåŠ¡**ï¼Œé€šè¿‡é€†å‘å·¥ç¨‹è±†åŒ…ç½‘é¡µç‰ˆçš„APIæ¥å£ï¼Œå®ç°äº†å¯¹è±†åŒ…AIå¯¹è¯æœåŠ¡çš„ä»£ç†è®¿é—®ã€‚è¯¥æœåŠ¡å…è®¸ç”¨æˆ·é€šè¿‡HTTP APIè°ƒç”¨è±†åŒ…çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€ç›´æ¥è®¿é—®ç½‘é¡µç‰ˆã€‚

### æ ¸å¿ƒåŠŸèƒ½

- âœ… èŠå¤©å¯¹è¯ï¼ˆæ”¯æŒæ–‡å­—å’Œå›¾ç‰‡ï¼‰
- âœ… æ–‡ä»¶ä¸Šä¼ ï¼ˆå›¾ç‰‡å’Œæ–‡æ¡£ï¼‰
- âœ… ä¼šè¯ç®¡ç†ï¼ˆåˆ›å»ºã€åˆ é™¤å¯¹è¯ï¼‰
- âœ… æ¸¸å®¢æ¨¡å¼æ”¯æŒ
- âœ… æ·±åº¦æ€è€ƒæ¨¡å¼
- âœ… è‡ªåŠ¨ä¸Šä¸‹æ–‡ç®¡ç†

---

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·/å®¢æˆ·ç«¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTPè¯·æ±‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      FastAPI WebæœåŠ¡å±‚               â”‚
â”‚  - è·¯ç”±å¤„ç†                          â”‚
â”‚  - è¯·æ±‚éªŒè¯                          â”‚
â”‚  - å“åº”æ ¼å¼åŒ–                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ä¸šåŠ¡é€»è¾‘å±‚ (Service)            â”‚
â”‚  - chat_completion()                 â”‚
â”‚  - upload_file()                     â”‚
â”‚  - delete_conversation()             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ä¼šè¯æ± ç®¡ç† (SessionPool)        â”‚
â”‚  - ä¼šè¯é…ç½®ç®¡ç†                       â”‚
â”‚  - è®¤è¯ä¿¡æ¯å­˜å‚¨                       â”‚
â”‚  - ä¼šè¯å¤ç”¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      è±†åŒ…å®˜æ–¹API                     â”‚
â”‚  - https://www.doubao.com/           â”‚
â”‚  - SSEæµå¼å“åº”                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒå®ç°åŸç†

### 1. ä¼šè¯è®¤è¯æœºåˆ¶ï¼ˆé€†å‘å·¥ç¨‹ï¼‰

#### 1.1 å…³é”®è®¤è¯å‚æ•°

è±†åŒ…ç½‘é¡µç‰ˆä½¿ç”¨ä»¥ä¸‹å‚æ•°è¿›è¡Œèº«ä»½è®¤è¯å’Œè¯·æ±‚è¿½è¸ªï¼š

| å‚æ•° | è¯´æ˜ | è·å–æ–¹å¼ |
|------|------|----------|
| `cookie` | ç”¨æˆ·ç™»å½•æ€ï¼ŒåŒ…å«sessionidã€sid_guardç­‰ | æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network â†’ Headers |
| `device_id` | è®¾å¤‡å”¯ä¸€æ ‡è¯† | URLå‚æ•°æˆ–è¯·æ±‚Headers |
| `tea_uuid` | ç”¨æˆ·å”¯ä¸€æ ‡è¯† | URLå‚æ•° |
| `web_id` | Webç«¯è®¾å¤‡ID | URLå‚æ•° |
| `room_id` | èŠå¤©å®¤ID | æµè§ˆå™¨URLæˆ–refererå¤´ |
| `x_flow_trace` | è¯·æ±‚é“¾è·¯è¿½è¸ªID | è¯·æ±‚Headers |

#### 1.2 è®¤è¯æµç¨‹

```python
# ä»session.jsonåŠ è½½é…ç½®
session = session_pool.get_session(conversation_id, guest)

# æ„é€ è®¤è¯Headers
headers = {
    'cookie': session.cookie,           # ç™»å½•æ€
    'referer': f"https://www.doubao.com/chat/{session.room_id}",
    'x-flow-trace': session.x_flow_trace,  # é“¾è·¯è¿½è¸ª
    'user-agent': 'Mozilla/5.0...',      # æ¨¡æ‹Ÿæµè§ˆå™¨
    'origin': "https://www.doubao.com"
}
```

**å…³é”®ç‚¹**ï¼š
- å¿…é¡»å®Œå…¨æ¨¡æ‹Ÿæµè§ˆå™¨è¯·æ±‚å¤´ï¼Œå¦åˆ™ä¼šè¢«æœåŠ¡å™¨æ‹’ç»
- Cookieéœ€è¦å®šæœŸæ›´æ–°ï¼ˆæœ‰æ—¶æ•ˆæ€§ï¼‰
- æ¯ä¸ªå¯¹è¯éœ€è¦å…³è”å¯¹åº”çš„sessioné…ç½®

---

### 2. èŠå¤©è¡¥å…¨æµç¨‹ (chat_completion)

#### 2.1 è¯·æ±‚æ„é€ 

```python
# URLå‚æ•°æ„é€ 
params = "&".join([
    "aid=497858",                    # åº”ç”¨IDï¼ˆå›ºå®šå€¼ï¼‰
    f"device_id={session.device_id}",
    "device_platform=web",
    "language=zh",
    "pc_version=2.23.2",            # å®¢æˆ·ç«¯ç‰ˆæœ¬
    "tea_uuid={session.tea_uuid}",
    "web_id={session.web_id}",
    # ... å…¶ä»–å‚æ•°
])

url = "https://www.doubao.com/samantha/chat/completion?" + params
```

#### 2.2 è¯·æ±‚ä½“æ„é€ 

```python
body = {
    "completion_option": {
        "is_regen": False,                    # æ˜¯å¦é‡æ–°ç”Ÿæˆ
        "with_suggest": False,                # æ˜¯å¦åŒ…å«å»ºè®®
        "need_create_conversation": conversation_id is None,  # æ˜¯å¦éœ€è¦åˆ›å»ºæ–°å¯¹è¯
        "launch_stage": 1,
        "use_auto_cot": use_auto_cot,         # è‡ªåŠ¨é€‰æ‹©æ·±åº¦æ€è€ƒ
        "use_deep_think": use_deep_think      # æ·±åº¦æ€è€ƒæ¨¡å¼
    },
    "conversation_id": "0" if conversation_id is None else conversation_id,
    "messages": [{
        "content": json.dumps({"text": prompt}),  # ç”¨æˆ·è¾“å…¥
        "content_type": 2001,                      # æ¶ˆæ¯ç±»å‹
        "attachments": attachments,                # é™„ä»¶ï¼ˆå›¾ç‰‡ç­‰ï¼‰
        "references": []
    }]
}

# å·²ç™»å½•ç”¨æˆ·éœ€è¦é¢å¤–çš„æœ¬åœ°ID
if not guest:
    body["local_conversation_id"] = f"local_{uuid.uuid4()}"
    body["local_message_id"] = str(uuid.uuid4())
```

#### 2.3 å‘é€è¯·æ±‚

```python
async with aiohttp.ClientSession() as session:
    async with session.post(url, headers=headers, json=body) as response:
        # å¤„ç†SSEæµå¼å“åº”
        text, images, conv_id, msg_id, sec_id = await handle_sse(response)
```

---

### 3. SSEæµå¼å“åº”å¤„ç† (handle_sse)

è±†åŒ…APIä½¿ç”¨**Server-Sent Events (SSE)** è¿”å›æµå¼å“åº”ï¼Œéœ€è¦é€å—è§£æã€‚

#### 3.1 SSEäº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|---------|------|----------|
| `2001` | æµæ¶ˆæ¯ï¼ˆå†…å®¹å—ï¼‰ | æå–æ–‡å­—æˆ–å›¾ç‰‡URL |
| `2002` | æµå¼€å§‹ | è·å–conversation_idã€message_idã€section_id |
| `2003` | æµç»“æŸ | è¿”å›å®Œæ•´ç»“æœ |

#### 3.2 å“åº”è§£ææµç¨‹

```python
async def handle_sse(response):
    buffer = ""
    texts = []
    image_urls = []
    
    # é€å—è¯»å–å“åº”
    async for chunk in response.content.iter_chunked(1024):
        buffer += chunk.decode('utf-8')
        
        # æŒ‰äº‹ä»¶åˆ†å‰²ï¼ˆSSEæ ¼å¼ï¼šdata: {...}\n\nï¼‰
        events = buffer.split('\n\n')
        buffer = events.pop()  # ä¿ç•™æœªå®Œæ•´çš„äº‹ä»¶
        
        for evt in events:
            # è§£æäº‹ä»¶æ•°æ®
            evt_obj = json.loads(data_line[6:])  # è·³è¿‡ "data: "
            event_type = evt_obj.get('event_type')
            event_data = json.loads(evt_obj.get('event_data', '{}'))
            
            if event_type == 2001:  # å†…å®¹æ¶ˆæ¯
                content_type = msg.get('content_type')
                if content_type in [10000, 2001, 2008]:  # æ–‡å­—
                    text = json.loads(msg.get('content')).get('text')
                    texts.append(text)
                elif content_type == 2074:  # å›¾ç‰‡
                    # æå–å›¾ç‰‡URL
                    image_urls.append(url)
            
            elif event_type == 2002:  # æµå¼€å§‹
                conversation_id = event_data.get("conversation_id")
                section_id = event_data.get("section_id")
            
            elif event_type == 2003:  # æµç»“æŸ
                return "".join(texts), image_urls, conversation_id, ...
```

#### 3.3 å†…å®¹ç±»å‹è¯´æ˜

| content_type | è¯´æ˜ |
|-------------|------|
| `10000` | ç³»ç»Ÿæ¶ˆæ¯ |
| `2001` | æ™®é€šæ–‡æœ¬æ¶ˆæ¯ |
| `2008` | ä»£ç å—æ¶ˆæ¯ |
| `2074` | å›¾ç‰‡ç”Ÿæˆæ¶ˆæ¯ |

---

### 4. æ–‡ä»¶ä¸Šä¼ æµç¨‹ (upload_file)

æ–‡ä»¶ä¸Šä¼ é‡‡ç”¨**å­—èŠ‚è·³åŠ¨ImageXæœåŠ¡**ï¼Œéœ€è¦4æ­¥å®Œæˆï¼š

#### 4.1 ä¸Šä¼ æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. prepare-uploadâ”‚ â†’ è·å–AWSä¸´æ—¶å‡­è¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. apply-upload  â”‚ â†’ æäº¤æ–‡ä»¶å…ƒä¿¡æ¯ï¼Œè·å–ä¸Šä¼ åœ°å€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. upload        â”‚ â†’ ä¸Šä¼ æ–‡ä»¶æ•°æ®åˆ°TOSå­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. commit-upload â”‚ â†’ ç¡®è®¤ä¸Šä¼ å®Œæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2 è¯¦ç»†æ­¥éª¤

**æ­¥éª¤1: Prepare Upload**
```python
prepare_url = "https://www.doubao.com/alice/resource/prepare_upload?" + params
prepare_payload = {
    "resource_type": file_type,  # 1=æ–‡æ¡£, 2=å›¾ç‰‡
    "scene_id": "5",
    "tenant_id": "5"
}
# è¿”å›: upload_auth_token (åŒ…å«access_key, secret_key, session_token)
```

**æ­¥éª¤2: Apply Upload**
```python
# ä½¿ç”¨AWS4Authç­¾å
auth = AWS4Auth(access_key, secret_key, 'cn-north-1', "imagex", 
                session_token=session_token)
# è¿”å›: StoreUri, Auth, SessionKey
```

**æ­¥éª¤3: Upload**
```python
upload_url = f"https://tos-d-x-hl.snssdk.com/upload/v1/{store_url}"
headers = {
    "authorization": store_auth,
    "content-crc32": crc32,  # æ–‡ä»¶CRC32æ ¡éªŒ
    "content-type": "application/octet-stream"
}
# ä¸Šä¼ æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®
```

**æ­¥éª¤4: Commit Upload**
```python
commit_url = f"https://imagex.bytedanceapi.com/?Action=CommitImageUpload..."
commit_payload = {"SessionKey": session_key}
# è¿”å›: ImageUri, ImageMd5, ImageSizeç­‰
```

---

### 5. ä¼šè¯æ± ç®¡ç† (SessionPool)

#### 5.1 ä¼šè¯æ± ç»“æ„

```python
class SessionPool:
    session_map: Dict[str, DoubaoSession]      # conversation_id -> Session
    auth_sessions: List[DoubaoSession]         # å·²ç™»å½•ä¼šè¯åˆ—è¡¨
    guest_sessions: List[DoubaoSession]        # æ¸¸å®¢ä¼šè¯åˆ—è¡¨
```

#### 5.2 ä¼šè¯è·å–ç­–ç•¥

```python
def get_session(conversation_id, guest=False):
    if conversation_id:
        # ä½¿ç”¨å·²æœ‰å¯¹è¯çš„sessionï¼ˆä¿æŒä¸Šä¸‹æ–‡ï¼‰
        return session_map.get(conversation_id)
    else:
        # æ–°å¯¹è¯ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªsession
        if guest:
            return random.choice(guest_sessions)
        else:
            return random.choice(auth_sessions)
```

#### 5.3 ä¼šè¯å…³è”

```python
# ç¬¬ä¸€æ¬¡å¯¹è¯åï¼Œå°†sessionä¸conversation_idå…³è”
session_pool.set_session(conversation_id, session)

# åç»­å¯¹è¯ä½¿ç”¨åŒä¸€ä¸ªsessionï¼Œä¿æŒç™»å½•æ€
```

---

### 6. è‡ªåŠ¨è·å–æ¸¸å®¢Session (DoubaoAutomator)

ä½¿ç”¨**Playwright**è‡ªåŠ¨åŒ–æµè§ˆå™¨ï¼Œè‡ªåŠ¨è·å–æ¸¸å®¢Sessioné…ç½®ã€‚

#### 6.1 è‡ªåŠ¨åŒ–æµç¨‹

```python
async def run_automation():
    # 1. å¯åŠ¨æµè§ˆå™¨
    browser = await playwright.chromium.launch()
    page = await browser.new_page()
    
    # 2. ç›‘å¬ç½‘ç»œè¯·æ±‚
    page.on('request', capture_request)
    
    # 3. è®¿é—®è±†åŒ…ç½‘ç«™
    await page.goto('https://www.doubao.com')
    
    # 4. æ‰¾åˆ°è¾“å…¥æ¡†å¹¶å‘é€æ¶ˆæ¯
    input_element = await page.wait_for_selector('textarea[data-testid="chat_input_input"]')
    await input_element.fill("ä½ å¥½")
    await input_element.press('Enter')
    
    # 5. æ•è·è¯·æ±‚ä¸­çš„è®¤è¯ä¿¡æ¯
    # - device_id, web_id, tea_uuid (ä»URLå‚æ•°)
    # - x_flow_trace (ä»Headers)
    # - room_id (ä»referer)
    # - cookie (ä»æµè§ˆå™¨cookies)
    
    # 6. è¿”å›é…ç½®ä¿¡æ¯
    return {
        "cookie": cookie_string,
        "device_id": device_id,
        "tea_uuid": tea_uuid,
        "web_id": web_id,
        "room_id": room_id,
        "x_flow_trace": x_flow_trace
    }
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. é€†å‘å·¥ç¨‹è¦ç‚¹

- **å®Œå…¨æ¨¡æ‹Ÿæµè§ˆå™¨è¯·æ±‚**ï¼šUser-Agentã€Refererã€Originç­‰å¿…é¡»ä¸€è‡´
- **Cookieç®¡ç†**ï¼šéœ€è¦å®šæœŸæ›´æ–°ï¼Œæœ‰æ—¶æ•ˆæ€§
- **è¯·æ±‚ç­¾å**ï¼šéƒ¨åˆ†æ¥å£éœ€è¦ç‰¹æ®Šç­¾åï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ä½¿ç”¨AWS4Authï¼‰
- **å‚æ•°æå–**ï¼šä»æµè§ˆå™¨Networké¢æ¿æå–çœŸå®å‚æ•°

### 2. SSEæµå¼å¤„ç†

- **ç¼“å†²æœºåˆ¶**ï¼šå¤„ç†ä¸å®Œæ•´çš„äº‹ä»¶å—
- **äº‹ä»¶è§£æ**ï¼šæŒ‰SSEæ ¼å¼è§£æï¼ˆ`data: {...}\n\n`ï¼‰
- **é”™è¯¯å¤„ç†**ï¼šæ£€æµ‹ç½‘å…³é”™è¯¯ã€æ¸¸å®¢é™åˆ¶ç­‰

### 3. ä¼šè¯ç®¡ç†

- **ä¼šè¯å¤ç”¨**ï¼šåŒä¸€conversation_idä½¿ç”¨åŒä¸€session
- **ä¼šè¯æ± **ï¼šæ”¯æŒå¤šä¸ªè´¦å·é…ç½®ï¼Œéšæœºé€‰æ‹©
- **ä¸Šä¸‹æ–‡ä¿æŒ**ï¼šé€šè¿‡conversation_idå’Œsection_idç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡

### 4. æ–‡ä»¶ä¸Šä¼ 

- **å¤šæ­¥éª¤æµç¨‹**ï¼šprepare â†’ apply â†’ upload â†’ commit
- **AWSç­¾å**ï¼šä½¿ç”¨AWS4Authè¿›è¡Œè¯·æ±‚ç­¾å
- **CRC32æ ¡éªŒ**ï¼šä¸Šä¼ æ—¶è¿›è¡Œæ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ

---

## æ•°æ®æµç¨‹

### èŠå¤©è¯·æ±‚å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·è¯·æ±‚
   POST /api/chat/completions
   {
     "prompt": "ä½ å¥½",
     "guest": false,
     "conversation_id": null
   }
   â†“
2. FastAPIè·¯ç”±
   â†’ éªŒè¯è¯·æ±‚å‚æ•°
   â†’ è°ƒç”¨ chat_completion()
   â†“
3. ä¼šè¯æ± è·å–
   â†’ session_pool.get_session(None, False)
   â†’ éšæœºé€‰æ‹©ä¸€ä¸ªå·²ç™»å½•session
   â†“
4. æ„é€ è±†åŒ…APIè¯·æ±‚
   â†’ ç»„è£…URLå‚æ•°
   â†’ æ„é€ è¯·æ±‚ä½“
   â†’ è®¾ç½®è®¤è¯Headers
   â†“
5. å‘é€HTTPè¯·æ±‚
   â†’ POST https://www.doubao.com/samantha/chat/completion
   â†’ æ¥æ”¶SSEæµå¼å“åº”
   â†“
6. è§£æSSEå“åº”
   â†’ é€å—è¯»å–å“åº”
   â†’ è§£æäº‹ä»¶ç±»å‹
   â†’ æå–æ–‡å­—å’Œå›¾ç‰‡
   â†“
7. ä¼šè¯å…³è”
   â†’ session_pool.set_session(conversation_id, session)
   â†“
8. è¿”å›ç»“æœ
   {
     "text": "ä½ å¥½ï¼æˆ‘æ˜¯è±†åŒ…...",
     "img_urls": [],
     "conversation_id": "xxx",
     "section_id": "yyy"
   }
```

### æ–‡ä»¶ä¸Šä¼ å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
   POST /api/file/upload?file_type=2&file_name=test.jpg
   Body: <binary data>
   â†“
2. Prepare Upload
   â†’ è·å–AWSä¸´æ—¶å‡­è¯
   â†“
3. Apply Upload
   â†’ æäº¤æ–‡ä»¶å…ƒä¿¡æ¯
   â†’ è·å–ä¸Šä¼ åœ°å€å’Œè®¤è¯ä¿¡æ¯
   â†“
4. Upload
   â†’ ä¸Šä¼ æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®åˆ°TOS
   â†’ è®¡ç®—CRC32æ ¡éªŒ
   â†“
5. Commit Upload
   â†’ ç¡®è®¤ä¸Šä¼ å®Œæˆ
   â†’ è·å–æ–‡ä»¶URIå’Œå…ƒä¿¡æ¯
   â†“
6. è¿”å›é™„ä»¶ä¿¡æ¯
   {
     "key": "image_uri",
     "name": "test.jpg",
     "type": "vlm_image",
     ...
   }
   â†“
7. åœ¨èŠå¤©ä¸­ä½¿ç”¨
   â†’ å°†é™„ä»¶ä¿¡æ¯æ·»åŠ åˆ°attachmentså‚æ•°
   â†’ å‘é€èŠå¤©è¯·æ±‚
```

---

## ä»£ç ç»“æ„åˆ†æ

### é¡¹ç›®ç›®å½•ç»“æ„

```
DoubaoFreeApi/
â”œâ”€â”€ app.py                    # FastAPIåº”ç”¨å…¥å£
â”œâ”€â”€ session.json              # ä¼šè¯é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt           # ä¾èµ–åŒ…
â”‚
â””â”€â”€ src/
    â”œâ”€â”€ api/                  # APIè·¯ç”±å±‚
    â”‚   â”œâ”€â”€ router.py         # è·¯ç”±æ³¨å†Œ
    â”‚   â””â”€â”€ endpoints/
    â”‚       â”œâ”€â”€ chat.py       # èŠå¤©æ¥å£
    â”‚       â””â”€â”€ file.py       # æ–‡ä»¶æ¥å£
    â”‚
    â”œâ”€â”€ model/                # æ•°æ®æ¨¡å‹
    â”‚   â”œâ”€â”€ request.py        # è¯·æ±‚æ¨¡å‹
    â”‚   â””â”€â”€ response.py       # å“åº”æ¨¡å‹
    â”‚
    â”œâ”€â”€ service/              # ä¸šåŠ¡é€»è¾‘å±‚
    â”‚   â””â”€â”€ doubao_service.py  # æ ¸å¿ƒæœåŠ¡å®ç°
    â”‚
    â”œâ”€â”€ pool/                 # ä¼šè¯æ± ç®¡ç†
    â”‚   â”œâ”€â”€ session_pool.py   # ä¼šè¯æ± å®ç°
    â”‚   â””â”€â”€ fetcher.py        # è‡ªåŠ¨è·å–Session
    â”‚
    â”œâ”€â”€ static/               # é™æ€èµ„æº
    â”‚   â”œâ”€â”€ css/
    â”‚   â””â”€â”€ js/
    â”‚
    â””â”€â”€ templates/            # HTMLæ¨¡æ¿
        â””â”€â”€ index.html
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### 1. `app.py` - åº”ç”¨å…¥å£
- FastAPIåº”ç”¨åˆå§‹åŒ–
- CORSä¸­é—´ä»¶é…ç½®
- é™æ€æ–‡ä»¶å’Œæ¨¡æ¿é…ç½®
- å¯åŠ¨æ—¶è·å–æ¸¸å®¢Session

#### 2. `doubao_service.py` - æ ¸å¿ƒæœåŠ¡
- `chat_completion()`: èŠå¤©è¡¥å…¨ä¸»é€»è¾‘
- `handle_sse()`: SSEæµå¼å“åº”å¤„ç†
- `upload_file()`: æ–‡ä»¶ä¸Šä¼ å››æ­¥æµç¨‹
- `delete_conversation()`: åˆ é™¤å¯¹è¯

#### 3. `session_pool.py` - ä¼šè¯ç®¡ç†
- `SessionPool`: ä¼šè¯æ± ç®¡ç†ç±»
- `DoubaoSession`: ä¼šè¯é…ç½®æ¨¡å‹
- ä¼šè¯åŠ è½½ã€ä¿å­˜ã€è·å–ã€å…³è”

#### 4. `fetcher.py` - è‡ªåŠ¨åŒ–è·å–
- `DoubaoAutomator`: Playwrightè‡ªåŠ¨åŒ–ç±»
- è‡ªåŠ¨è®¿é—®ç½‘ç«™ã€å‘é€æ¶ˆæ¯ã€æ•è·è¯·æ±‚

---

## å®‰å…¨ä¸é™åˆ¶

### 1. æ¸¸å®¢æ¨¡å¼é™åˆ¶
- æ¸¸å®¢è´¦å·é™åˆ¶5æ¬¡å¯¹è¯
- ä¸æ”¯æŒä¸Šä¸‹æ–‡ï¼ˆconversation_idï¼‰
- éœ€è¦å®šæœŸè·å–æ–°çš„æ¸¸å®¢Session

### 2. è®¤è¯ä¿¡æ¯æ—¶æ•ˆæ€§
- Cookieæœ‰æ—¶æ•ˆæ€§ï¼Œéœ€è¦å®šæœŸæ›´æ–°
- å»ºè®®å®šæœŸä»æµè§ˆå™¨é‡æ–°æŠ“å–é…ç½®

### 3. è¯·æ±‚é¢‘ç‡é™åˆ¶
- å¯èƒ½å—åˆ°è±†åŒ…æœåŠ¡å™¨çš„é¢‘ç‡é™åˆ¶
- å»ºè®®åˆç†æ§åˆ¶è¯·æ±‚é¢‘ç‡

### 4. æ³¨æ„äº‹é¡¹
- âš ï¸ ä¸è¦åˆ†äº«ä¸ªäººé…ç½®ä¿¡æ¯ï¼ˆsession.jsonï¼‰
- âš ï¸ é…ç½®ä¿¡æ¯åŒ…å«æ•æ„Ÿè®¤è¯æ•°æ®
- âš ï¸ æ­¤é¡¹ç›®ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨

---

## æ€»ç»“

è¿™ä¸ªè±†åŒ…APIä»£ç†æœåŠ¡çš„æ ¸å¿ƒåŸç†æ˜¯ï¼š

1. **é€†å‘å·¥ç¨‹**ï¼šé€šè¿‡åˆ†æè±†åŒ…ç½‘é¡µç‰ˆçš„ç½‘ç»œè¯·æ±‚ï¼Œæå–å…³é”®è®¤è¯å‚æ•°
2. **è¯·æ±‚æ¨¡æ‹Ÿ**ï¼šå®Œå…¨æ¨¡æ‹Ÿæµè§ˆå™¨è¯·æ±‚ï¼ŒåŒ…æ‹¬Headersã€Cookieç­‰
3. **æµå¼å¤„ç†**ï¼šè§£æSSEæµå¼å“åº”ï¼Œæå–æ–‡å­—å’Œå›¾ç‰‡å†…å®¹
4. **ä¼šè¯ç®¡ç†**ï¼šé€šè¿‡ä¼šè¯æ± ç®¡ç†å¤šä¸ªè´¦å·é…ç½®ï¼Œæ”¯æŒä¸Šä¸‹æ–‡ä¿æŒ
5. **æ–‡ä»¶ä¸Šä¼ **ï¼šå®ç°å­—èŠ‚è·³åŠ¨ImageXæœåŠ¡çš„å®Œæ•´ä¸Šä¼ æµç¨‹

è¯¥æœåŠ¡å®ç°äº†å¯¹è±†åŒ…APIçš„é€æ˜ä»£ç†ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç®€å•çš„HTTP APIè°ƒç”¨è±†åŒ…çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€ç›´æ¥è®¿é—®ç½‘é¡µç‰ˆã€‚

---

## å‚è€ƒèµ„æ–™

- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Server-Sent Events (SSE)è§„èŒƒ](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [Playwrightæ–‡æ¡£](https://playwright.dev/)
- [AWS Signature Version 4](https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html)

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-01-13*
*é¡¹ç›®ç‰ˆæœ¬: 0.2.0*

