<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI API Gateway ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .prose pre { background: #f3f4f6; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
        .prose code { background: #f3f4f6; padding: 0.2em 0.4em; border-radius: 0.25em; font-size: 0.9em; }
        /* Tailwind preflight resets links/lists; restore basic Markdown readability */
        .prose a { color: #2563eb; text-decoration: underline; word-break: break-word; }
        .prose a:hover { color: #1d4ed8; }
        .prose ol { list-style: decimal; padding-left: 1.25rem; }
        .prose ul { list-style: disc; padding-left: 1.25rem; }
        .prose li { margin: 0.25rem 0; }
        .prose p { margin: 0.5rem 0; }
        .prose strong { font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-gray-800">AI API Gateway é…ç½®ç®¡ç†</h1>
        
        <div id="services-container" class="space-y-6">
            <!-- Services will be injected here -->
        </div>

        <div class="mt-8 flex justify-end gap-4">
            <button onclick="openApiDocs()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded shadow-lg transition duration-200 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                API è°ƒç”¨è¯´æ˜
            </button>
            <button onclick="saveConfig()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow-lg transition duration-200">
                ä¿å­˜æ‰€æœ‰é…ç½®
            </button>
        </div>
    </div>

    <!-- API Docs Modal -->
    <div id="api-docs-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 flex">
        <div class="bg-white w-11/12 max-w-4xl rounded-lg shadow-2xl flex flex-col relative max-h-[90vh]">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="text-lg font-bold text-gray-800">API è°ƒç”¨æŒ‡å—</h3>
                <button onclick="closeApiDocs()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto prose prose-sm max-w-none text-gray-700">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <p class="font-bold text-blue-700">OpenAI å…¼å®¹æ¥å£</p>
                    <p class="text-sm text-blue-600">æœ¬æœåŠ¡æä¾›å®Œå…¨å…¼å®¹ OpenAI æ ¼å¼çš„æ¥å£ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ OpenAI SDK æˆ–ä»»ä½•æ”¯æŒ OpenAI çš„å®¢æˆ·ç«¯ã€‚</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-base font-bold mb-2">åŸºç¡€ä¿¡æ¯</h4>
                        <ul class="list-disc pl-5 space-y-1 text-sm">
                            <li><strong>Base URL:</strong> <code>http://8.137.117.8:8888/v1</code></li>
                            <li><strong>API Key:</strong> ä»»æ„éç©ºå­—ç¬¦ä¸² (ä¾‹å¦‚: <code>sk-123456</code>) <br><span class="text-xs text-gray-500">*é‰´æƒå·²åœ¨åå°é…ç½®ï¼Œæ­¤å¤„ä»…ä¸ºæ»¡è¶³å®¢æˆ·ç«¯æ ¼å¼è¦æ±‚</span></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-base font-bold mb-2">æ”¯æŒæ¨¡å‹</h4>
                        <p class="text-xs text-gray-500 mb-2">æ¨¡å‹åç§°å°†è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”çš„æœåŠ¡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨æ¨¡å‹ï¼š</p>
                        <div class="flex flex-wrap gap-2">
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">deepseek-chat</span>
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">deepseek-r1</span>
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">glm-4.5</span>
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">kimi-latest</span>
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">qwen-plus</span>
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">doubao-pro-4k</span>
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">ernie-4.0-8k</span>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 border-l-4 border-green-500 p-4 mt-6">
                    <p class="font-bold text-green-700">NewAPI / OneAPI æ¥å…¥æŒ‡å—</p>
                    <p class="text-sm text-green-600 mb-2">æœ¬ç³»ç»Ÿå®Œç¾å…¼å®¹ NewAPI å’Œ OneAPIï¼Œæ‚¨å¯ä»¥è½»æ¾å°†å…¶æ·»åŠ ä¸ºä¸€ä¸ªæ–°çš„æ¸ é“ã€‚</p>
                    <ul class="list-disc pl-5 space-y-1 text-sm text-green-800">
                        <li><strong>æ¸ é“ç±»å‹ (Channel Type):</strong> é€‰æ‹© <code>OpenAI</code> (æˆ–è‡ªå®šä¹‰ OpenAI)</li>
                        <li><strong>ä»£ç†åœ°å€ (Base URL):</strong> <code>http://8.137.117.8:8888</code> <br><span class="text-xs text-gray-500">*é€šå¸¸ç³»ç»Ÿä¼šè‡ªåŠ¨æ‹¼æ¥ /v1ï¼Œå¦‚æµ‹è¯•ä¸é€šè¯·å°è¯•å®Œæ•´è·¯å¾„ <code>http://8.137.117.8:8888/v1</code></span></li>
                        <li><strong>å¯†é’¥ (Key):</strong> ä»»æ„éç©ºå­—ç¬¦ä¸² (ä¾‹å¦‚: <code>sk-newapi</code>)</li>
                        <li><strong>æ¨¡å‹ (Models):</strong> æ‰‹åŠ¨è¾“å…¥æ”¯æŒçš„æ¨¡å‹åç§° (å»ºè®®å¤åˆ¶ä¸‹æ–¹å®Œæ•´åˆ—è¡¨)</li>
                    </ul>
                </div>

                <h4 class="text-base font-bold mt-6 mb-2">è°ƒç”¨ç¤ºä¾‹ (Python)</h4>
                <pre><code class="language-python">from openai import OpenAI

client = OpenAI(
    base_url="http://8.137.117.8:8888/v1",  # æ‚¨çš„éƒ¨ç½²åœ°å€
    api_key="sk-any-string"               # ä»»æ„å¡«å†™
)

response = client.chat.completions.create(
    model="deepseek-chat",                # æ›¿æ¢ä¸ºä½ æƒ³è°ƒç”¨çš„æ¨¡å‹
    messages=[
        {"role": "user", "content": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±"}
    ],
    stream=True                           # æ¨èå¼€å¯æµå¼
)

for chunk in response:
    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end="", flush=True)</code></pre>

                <h4 class="text-base font-bold mt-6 mb-2">è°ƒç”¨ç¤ºä¾‹ (cURL)</h4>
                <pre><code class="language-bash">curl http://localhost:8888/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-any-string" \
  -d '{
    "model": "deepseek-chat",
    "messages": [
      {"role": "user", "content": "Hello!"}
    ],
    "stream": true
  }'</code></pre>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                <button onclick="closeApiDocs()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 flex">
        <div class="bg-white w-11/12 max-w-4xl h-5/6 rounded-lg shadow-2xl flex flex-col relative">
            <!-- Header -->
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <div>
                    <h3 class="text-lg font-bold text-gray-800" id="chat-title">Chat Test</h3>
                    <p class="text-xs text-gray-500" id="chat-subtitle">Model: -</p>
                </div>
                <button onclick="closeChat()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            
            <!-- Chat History -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Messages will appear here -->
                <div class="text-center text-gray-400 mt-10">åœ¨è¿™é‡Œæµ‹è¯•ä½ çš„ AI æ¨¡å‹</div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t bg-gray-50 rounded-b-lg">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" 
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€..." 
                        autocomplete="off">
                    <button onclick="sendMessage()" id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded-lg transition-colors">
                        å‘é€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 flex">
        <div class="bg-white w-11/12 max-w-2xl rounded-lg shadow-2xl flex flex-col relative max-h-[90vh]">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="text-lg font-bold text-gray-800" id="help-title">è·å– Token æŒ‡å—</h3>
                <button onclick="closeHelp()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="help-content" class="p-6 overflow-y-auto prose prose-sm max-w-none text-gray-700">
                <!-- Content injected here -->
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                <button onclick="closeHelp()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Yuanbao Login Modal -->
    <div id="yuanbao-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 flex">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-96 text-center relative">
            <button onclick="closeYuanbaoLogin()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
            
            <h3 class="text-xl font-bold mb-4 text-gray-800">å¾®ä¿¡æ‰«ç ç™»å½•å…ƒå®</h3>
            
            <div id="yuanbao-qr-container" class="flex justify-center mb-4 min-h-[200px] items-center">
                <div class="animate-pulse bg-gray-200 w-48 h-48 rounded"></div>
            </div>
            
            <p id="yuanbao-status" class="text-sm text-gray-600 mb-4">æ­£åœ¨è·å–äºŒç»´ç ...</p>
            
            <div class="text-xs text-gray-400 text-left bg-gray-50 p-3 rounded">
                <p>1. è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æä¸Šæ–¹äºŒç»´ç ã€‚</p>
                <p>2. åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•ã€‚</p>
                <p>3. ç™»å½•æˆåŠŸåï¼ŒCookie å°†è‡ªåŠ¨å¡«å…¥ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        const helpDocs = {
            deepseek: `
                <ol class="list-decimal pl-5 space-y-2">
                    <li>è®¿é—® <a href="https://chat.deepseek.com/" target="_blank">DeepSeek å®˜ç½‘</a> å¹¶ç™»å½•ã€‚</li>
                    <li>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° <strong>Application</strong> (åº”ç”¨) é€‰é¡¹å¡ã€‚</li>
                    <li>åœ¨å·¦ä¾§èœå•æ‰¾åˆ° <strong>Local Storage</strong> (æœ¬åœ°å­˜å‚¨)ï¼Œç‚¹å‡» <code>https://chat.deepseek.com</code>ã€‚</li>
                    <li>æ‰¾åˆ° Key ä¸º <code>userToken</code> çš„é¡¹ï¼Œå¤åˆ¶å…¶ <strong>Value</strong> å€¼ã€‚</li>
                </ol>
                <div class="mt-2 p-2 bg-gray-100 rounded text-xs text-gray-500 break-all">ç¤ºä¾‹: {"value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", ...} (æ³¨æ„ï¼šé€šå¸¸åªéœ€è¦ value å­—æ®µé‡Œçš„ token å­—ç¬¦ä¸²ï¼Œä½†å¦‚æœå¤åˆ¶äº†æ•´ä¸ª JSON ä¹Ÿå¯ä»¥å°è¯•)</div>
            `,
            glm: `
                <ol class="list-decimal pl-5 space-y-2">
                    <li>è®¿é—® <a href="https://chatglm.cn/" target="_blank">æ™ºè°±æ¸…è¨€</a> å¹¶ç™»å½•ã€‚</li>
                    <li>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° <strong>Application</strong> (åº”ç”¨) é€‰é¡¹å¡ã€‚</li>
                    <li>åœ¨å·¦ä¾§èœå•æ‰¾åˆ° <strong>Cookies</strong>ï¼Œç‚¹å‡» <code>https://chatglm.cn</code>ã€‚</li>
                    <li>æ‰¾åˆ° Name ä¸º <code>chatglm_refresh_token</code> çš„é¡¹ï¼Œå¤åˆ¶å…¶ <strong>Value</strong> å€¼ã€‚</li>
                </ol>
            `,
            kimi: `
                <p class="font-bold mb-2">æ–¹æ³•ä¸€ (æ¨è)ï¼š</p>
                <ol class="list-decimal pl-5 space-y-2 mb-4">
                    <li>è®¿é—® <a href="https://kimi.moonshot.cn/" target="_blank">Kimi æ™ºèƒ½åŠ©æ‰‹</a> å¹¶ç™»å½•ã€‚</li>
                    <li>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° <strong>Application</strong> (åº”ç”¨) é€‰é¡¹å¡ã€‚</li>
                    <li>åœ¨å·¦ä¾§èœå•æ‰¾åˆ° <strong>Local Storage</strong>ï¼Œç‚¹å‡» <code>https://kimi.moonshot.cn</code>ã€‚</li>
                    <li>æ‰¾åˆ° <code>refresh_token</code>ã€‚å¦‚æœæ˜¯æ•°ç»„ï¼Œè¯·å°†å®ƒä»¬ç”¨ <code>.</code> è¿æ¥èµ·æ¥ã€‚</li>
                </ol>
                <p class="font-bold mb-2">æ–¹æ³•äºŒ (Cookie)ï¼š</p>
                <ol class="list-decimal pl-5 space-y-2">
                    <li>åœ¨ <strong>Cookies</strong> ä¸­æ‰¾åˆ° <code>kimi-auth</code> çš„å€¼ã€‚</li>
                </ol>
            `,
            qwen: `
                <ol class="list-decimal pl-5 space-y-2">
                    <li>è®¿é—® <a href="https://tongyi.aliyun.com/qianwen" target="_blank">é€šä¹‰åƒé—®</a> å¹¶ç™»å½•ã€‚</li>
                    <li>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° <strong>Application</strong> (åº”ç”¨) é€‰é¡¹å¡ã€‚</li>
                    <li>åœ¨å·¦ä¾§èœå•æ‰¾åˆ° <strong>Cookies</strong>ï¼Œç‚¹å‡» <code>https://tongyi.aliyun.com</code>ã€‚</li>
                    <li>æ‰¾åˆ° <code>tongyi_sso_ticket</code> æˆ– <code>login_aliyunid_ticket</code> çš„å€¼ï¼Œå¤åˆ¶å³å¯ã€‚</li>
                </ol>
            `,
            doubao: `
                <ol class="list-decimal pl-5 space-y-2">
                    <li>è®¿é—® <a href="https://www.doubao.com/" target="_blank">è±†åŒ…</a> å¹¶ç™»å½•ã€‚</li>
                    <li>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° <strong>Network</strong> (ç½‘ç»œ) é€‰é¡¹å¡ã€‚</li>
                    <li>åœ¨é¡µé¢å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç½‘ç»œè¯·æ±‚ (å¦‚ <code>chat</code>)ã€‚</li>
                    <li>æ”¶é›†ä»¥ä¸‹ä¿¡æ¯å¹¶ç»„åˆæˆ JSON:
                        <ul class="list-disc pl-5 mt-1 text-xs text-gray-600">
                            <li><code>cookie</code> (Request Headers)</li>
                            <li><code>tea_uuid</code>, <code>device_id</code>, <code>web_id</code> (Query Params)</li>
                            <li><code>x_flow_trace</code> (Request Headers)</li>
                        </ul>
                    </li>
                </ol>
                <div class="mt-2 p-2 bg-gray-100 rounded text-xs font-mono">{"cookie":"...","device_id":"...",...}</div>
            `,
            yuanbao: `
                <p><strong>æ¨èä½¿ç”¨æ‰«ç ç™»å½•åŠŸèƒ½è‡ªåŠ¨è·å–ã€‚</strong></p>
                <p class="mt-2">æ‰‹åŠ¨è·å–æ–¹æ³•ï¼š</p>
                <ol class="list-decimal pl-5 space-y-2">
                    <li>è®¿é—® <a href="https://yuanbao.tencent.com/" target="_blank">è…¾è®¯å…ƒå®</a> å¹¶ç™»å½•ã€‚</li>
                    <li>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹ç½‘ç»œè¯·æ±‚ã€‚</li>
                    <li>è·å– Cookie ä¸­çš„ <code>hy_user</code>, <code>hy_token</code>ã€‚</li>
                    <li>è·å–è¯·æ±‚ä½“ (Payload) ä¸­çš„ <code>agent_id</code>ã€‚</li>
                </ol>
            `,
            baidu: `
                <ol class="list-decimal pl-5 space-y-2">
                    <li>è®¿é—® <a href="https://chat.baidu.com/" target="_blank">ç™¾åº¦æ–‡å¿ƒä¸€è¨€</a> å¹¶ç™»å½•ã€‚</li>
                    <li>æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° <strong>Application</strong> (åº”ç”¨) é€‰é¡¹å¡ã€‚</li>
                    <li>åœ¨å·¦ä¾§èœå•æ‰¾åˆ° <strong>Cookies</strong>ï¼Œç‚¹å‡» <code>https://chat.baidu.com</code>ã€‚</li>
                    <li>æ­¤æœåŠ¡éœ€è¦å®Œæ•´çš„ Cookie å­—ç¬¦ä¸²ã€‚</li>
                    <li>å»ºè®®ï¼šåœ¨ Console (æ§åˆ¶å°) è¾“å…¥ <code>document.cookie</code> å¹¶å›è½¦ï¼Œå¤åˆ¶å¾—åˆ°çš„å®Œæ•´å­—ç¬¦ä¸²ã€‚</li>
                </ol>
            `
        };

        let currentConfig = {};
        let currentModel = '';
        let chatHistory = [];

        let yuanbaoPollInterval = null;
        let currentYuanbaoKey = null;

        function openYuanbaoLogin(key) {
            currentYuanbaoKey = key;
            const modal = document.getElementById('yuanbao-modal');
            const qrContainer = document.getElementById('yuanbao-qr-container');
            const statusText = document.getElementById('yuanbao-status');
            
            modal.classList.remove('hidden');
            qrContainer.innerHTML = '<div class="animate-pulse bg-gray-200 w-48 h-48 rounded"></div>';
            statusText.innerText = 'æ­£åœ¨è·å–äºŒç»´ç ...';
            statusText.className = 'text-sm text-gray-600 mb-4';

            // Fetch QR Code
            fetch('/api/yuanbao/login/qrcode')
                .then(response => response.json())
                .then(data => {
                    if (data.qrcode_url && data.uuid) {
                        // Display QR Code
                        // Note: WeChat QR code URLs might need to be proxied or handled carefully if strict Referrer policies apply,
                        // but usually they work in img tags.
                        qrContainer.innerHTML = `<img src="${data.qrcode_url}" alt="Scan QR Code" class="w-48 h-48 shadow-md rounded">`;
                        statusText.innerText = 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç ';
                        
                        // Start Polling
                        startYuanbaoPolling(data.uuid);
                    } else {
                        statusText.innerText = 'è·å–äºŒç»´ç å¤±è´¥ï¼Œè¯·é‡è¯•';
                        statusText.className = 'text-sm text-red-600 mb-4';
                    }
                })
                .catch(err => {
                    console.error('Error fetching QR code:', err);
                    statusText.innerText = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                    statusText.className = 'text-sm text-red-600 mb-4';
                });
        }

        function closeYuanbaoLogin() {
            const modal = document.getElementById('yuanbao-modal');
            modal.classList.add('hidden');
            if (yuanbaoPollInterval) {
                clearInterval(yuanbaoPollInterval);
                yuanbaoPollInterval = null;
            }
            currentYuanbaoKey = null;
        }

        function startYuanbaoPolling(uuid) {
            if (yuanbaoPollInterval) clearInterval(yuanbaoPollInterval);
            
            yuanbaoPollInterval = setInterval(() => {
                fetch(`/api/yuanbao/login/status?uuid=${uuid}`)
                    .then(response => response.json())
                    .then(data => {
                        const statusText = document.getElementById('yuanbao-status');
                        
                        if (data.status === 'success') {
                            clearInterval(yuanbaoPollInterval);
                            statusText.innerText = 'ç™»å½•æˆåŠŸï¼æ­£åœ¨å¡«å…¥ Cookie...';
                            statusText.className = 'text-sm text-green-600 mb-4 font-bold';
                            
                            // Fill the input
                            if (currentYuanbaoKey !== null) {
                                const hyUserInput = document.getElementById(`hy_user-${currentYuanbaoKey}`);
                                const hyTokenInput = document.getElementById(`hy_token-${currentYuanbaoKey}`);
                                const agentIdInput = document.getElementById(`agent_id-${currentYuanbaoKey}`);
                                
                                if (hyUserInput && hyTokenInput && agentIdInput) {
                                    hyUserInput.value = data.hy_user || '';
                                    hyTokenInput.value = data.hy_token || '';
                                    agentIdInput.value = data.agent_id || '';
                                    
                                    // Visual feedback
                                    [hyUserInput, hyTokenInput, agentIdInput].forEach(el => {
                                        el.classList.add('bg-green-100');
                                        setTimeout(() => el.classList.remove('bg-green-100'), 1000);
                                    });
                                }
                            }
                            
                            // Close modal after delay
                            setTimeout(() => {
                                closeYuanbaoLogin();
                            }, 1500);
                            
                        } else if (data.status === 'scanned') {
                            statusText.innerText = 'å·²æ‰«ç ï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•';
                            statusText.className = 'text-sm text-blue-600 mb-4 font-bold';
                        } else if (data.status === 'waiting') {
                            statusText.innerText = 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç ';
                            statusText.className = 'text-sm text-gray-600 mb-4';
                        } else if (data.status === 'expired') {
                            clearInterval(yuanbaoPollInterval);
                            statusText.innerText = 'äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·å…³é—­é‡è¯•';
                            statusText.className = 'text-sm text-red-600 mb-4';
                        } else if (data.status === 'refused') {
                            clearInterval(yuanbaoPollInterval);
                            statusText.innerText = 'æ‚¨å–æ¶ˆäº†ç™»å½•';
                            statusText.className = 'text-sm text-red-600 mb-4';
                        }
                    })
                    .catch(err => {
                        console.error('Polling error:', err);
                        // Don't stop polling immediately on single network error, but maybe log it
                    });
            }, 1500);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('yuanbao-modal');
            if (event.target == modal) {
                closeYuanbaoLogin();
            }
        }

        async function loadConfig() {
            const res = await fetch('/api/config');
            currentConfig = await res.json();
            renderServices();
        }

        function renderServices() {
            const container = document.getElementById('services-container');
            container.innerHTML = '';

            for (const [key, service] of Object.entries(currentConfig)) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6';
                
                // --- Accounts Management UI ---
                let accountsHtml = '';
                
                // Normalize accounts to array
                let accounts = [];
                if (Array.isArray(service.token)) {
                    accounts = service.token;
                } else if (service.token) {
                    accounts = [service.token];
                }

                // Try to migrate legacy flat yuanbao config to account object if needed
                if (key === 'yuanbao' && accounts.length === 0 && service.hy_token) {
                     accounts = [{
                         hy_user: service.hy_user,
                         hy_token: service.hy_token,
                         agent_id: service.agent_id
                     }];
                }

                // Render existing accounts list
                if (accounts.length > 0) {
                    accountsHtml += `<div class="space-y-3 mb-4">`;
                    accounts.forEach((acc, index) => {
                        let displayInfo = '';
                        if (typeof acc === 'object' && acc !== null) {
                            // Yuanbao Object
                             displayInfo = `
                                <div class="grid grid-cols-1 gap-1 text-xs">
                                    <div class="font-mono text-gray-600">hy_user: <span class="text-gray-800 font-bold">${(acc.hy_user || '').substring(0, 20)}...</span></div>
                                    <div class="font-mono text-gray-600">agent_id: ${(acc.agent_id || '')}</div>
                                </div>
                             `;
                        } else {
                            const str = String(acc);
                            if (str.trim().startsWith("{") || str.trim().startsWith("[")) {
                                try {
                                    const parsed = JSON.parse(str);
                                    if (key === 'doubao' && parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                                        const cookiePreview = parsed.cookie ? String(parsed.cookie).slice(0, 24) : '';
                                        const deviceId = parsed.device_id ? String(parsed.device_id) : '';
                                        const webId = parsed.web_id ? String(parsed.web_id) : '';
                                        const teaUuid = parsed.tea_uuid ? String(parsed.tea_uuid) : '';
                                        displayInfo = `
                                            <div class="grid grid-cols-1 gap-1 text-xs">
                                                <div class="font-mono text-gray-600">cookie: <span class="text-gray-800 font-bold">${cookiePreview}${cookiePreview ? '...' : ''}</span></div>
                                                ${deviceId ? `<div class="font-mono text-gray-600">device_id: ${deviceId}</div>` : ``}
                                                ${webId ? `<div class="font-mono text-gray-600">web_id: ${webId}</div>` : ``}
                                                ${teaUuid ? `<div class="font-mono text-gray-600">tea_uuid: ${teaUuid}</div>` : ``}
                                            </div>
                                        `;
                                    } else {
                                        const keys = parsed && typeof parsed === 'object' ? Object.keys(parsed).slice(0, 6).join(', ') : '';
                                        const preview = keys ? `{${keys}${Object.keys(parsed || {}).length > 6 ? ', ...' : ''}}` : str;
                                        displayInfo = `<div class="font-mono text-xs text-gray-600 break-all">${preview}</div>`;
                                    }
                                } catch (e) {
                                    const preview = str.length > 50 ? str.substring(0, 50) + '...' : str;
                                    displayInfo = `<div class="font-mono text-xs text-gray-600 break-all">${preview}</div>`;
                                }
                            } else {
                                const preview = str.length > 50 ? str.substring(0, 50) + '...' : str;
                                displayInfo = `<div class="font-mono text-xs text-gray-600 break-all">${preview}</div>`;
                            }
                        }

                        accountsHtml += `
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200">
                                <div class="flex items-center gap-3">
                                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded">#${index + 1}</span>
                                    ${displayInfo}
                                </div>
                                <button onclick="removeAccount('${key}', ${index})" class="text-red-500 hover:text-red-700 p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        `;
                    });
                    accountsHtml += `</div>`;
                } else {
                     accountsHtml += `<div class="text-sm text-gray-400 italic mb-4">æš‚æ— è´¦å·é…ç½®</div>`;
                }

                // Add Button & Form
                const formId = `add-form-${key}`;
                accountsHtml += `
                    <div id="${formId}" class="hidden bg-gray-50 p-4 rounded border border-blue-200 mb-4">
                        ${key === 'yuanbao' ? `
                            <div class="grid grid-cols-1 gap-3">
                                <input type="text" id="new-hy_user-${key}" class="w-full shadow-sm border rounded py-1 px-2 text-sm" placeholder="hy_user">
                                <input type="text" id="new-hy_token-${key}" class="w-full shadow-sm border rounded py-1 px-2 text-sm" placeholder="hy_token">
                                <input type="text" id="new-agent_id-${key}" class="w-full shadow-sm border rounded py-1 px-2 text-sm" placeholder="agent_id">
                                
                                <div class="flex gap-2">
                                     <button onclick="openYuanbaoLoginForAdd('${key}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 rounded">
                                        ğŸ“± æ‰«ç è·å–
                                    </button>
                                    <button onclick="confirmAddAccount('${key}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded">
                                        ç¡®è®¤æ·»åŠ 
                                    </button>
                                </div>
                            </div>
                        ` : key === 'doubao' ? `
                            <div class="p-2 bg-gray-50 rounded border text-sm text-gray-600 mb-3">
                                è±†åŒ…è´¦å·éœ€è¦å¤šä¸ªå‚æ•°ï¼›è¿™é‡Œä¸€é¡¹ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œä¿å­˜æ—¶è‡ªåŠ¨ç»„åˆæˆ JSONã€‚
                            </div>
                            <div class="grid grid-cols-1 gap-3">
                                <textarea id="new-doubao-cookie-${key}" rows="2" class="w-full shadow-sm border rounded py-1 px-2 text-sm font-mono" placeholder="cookie (å¿…å¡«ï¼Œå¤åˆ¶å®Œæ•´ cookie å­—ç¬¦ä¸²)"></textarea>
                                <input type="text" id="new-doubao-device_id-${key}" class="w-full shadow-sm border rounded py-1 px-2 text-sm font-mono" placeholder="device_id (å¯é€‰)">
                                <input type="text" id="new-doubao-web_id-${key}" class="w-full shadow-sm border rounded py-1 px-2 text-sm font-mono" placeholder="web_id (å¯é€‰)">
                                <input type="text" id="new-doubao-tea_uuid-${key}" class="w-full shadow-sm border rounded py-1 px-2 text-sm font-mono" placeholder="tea_uuid (å¯é€‰)">
                                <input type="text" id="new-doubao-x_flow_trace-${key}" class="w-full shadow-sm border rounded py-1 px-2 text-sm font-mono" placeholder="x_flow_trace (å¯é€‰)">
                                <div class="bg-white rounded border border-gray-200 p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-xs font-bold text-gray-700">å…¶ä»–å‚æ•°</div>
                                        <button onclick="addDoubaoExtraField('${key}')" class="text-xs text-blue-600 hover:text-blue-800 underline">æ–°å¢ä¸€é¡¹</button>
                                    </div>
                                    <div id="doubao-extra-${key}" class="space-y-2"></div>
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="confirmAddAccount('${key}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded">
                                        ç¡®è®¤æ·»åŠ 
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="flex gap-2">
                                <textarea id="new-token-${key}" rows="3" class="flex-1 shadow-sm border rounded py-1 px-2 text-sm font-mono" placeholder="${key === 'baidu' ? 'è¯·è¾“å…¥å®Œæ•´ Cookie JSON æˆ–å­—ç¬¦ä¸²' : 'è¯·è¾“å…¥ Token / Cookie'}"></textarea>
                            </div>
                            <div class="mt-2 flex justify-end">
                                <button onclick="confirmAddAccount('${key}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded">
                                    ç¡®è®¤æ·»åŠ 
                                </button>
                            </div>
                        `}
                    </div>
                    
                    <button onclick="toggleAddForm('${key}')" id="btn-add-${key}" class="w-full border-2 border-dashed border-gray-300 hover:border-blue-500 text-gray-500 hover:text-blue-500 font-bold py-2 px-4 rounded transition-colors flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        æ·»åŠ è´¦å·
                    </button>
                `;
                
                // --- End Accounts Management UI ---

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <h2 class="text-xl font-semibold text-gray-700 capitalize">${key} æœåŠ¡</h2>
                            <button onclick="openChatByService('${key}')" class="bg-green-100 hover:bg-green-200 text-green-700 text-xs font-bold py-1 px-3 rounded flex items-center gap-1 transition-colors">
                                ğŸ’¬ æµ‹è¯•èŠå¤©
                            </button>
                        </div>
                        <span class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded truncate max-w-[200px]">${service.url}</span>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <button onclick="testConnection('${key}')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded flex items-center gap-1 transition-colors">
                            ğŸ“¡ æµ‹è¯•è¿æ¥
                        </button>
                        <span id="test-status-${key}" class="text-xs flex items-center"></span>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 text-sm font-bold">è´¦å·åˆ—è¡¨ (è‡ªåŠ¨è½®è¯¢)</label>
                            <button onclick="openHelp('${key}')" class="text-xs text-blue-600 hover:text-blue-800 underline flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                å¦‚ä½•è·å– Token?
                            </button>
                        </div>
                        ${accountsHtml}
                    </div>

                    ${key === 'kimi' ? `
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="enable-search-${key}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        <label for="enable-search-${key}" class="ml-2 text-sm font-medium text-gray-900">å¯ç”¨è”ç½‘æœç´¢ (Internet Search)</label>
                    </div>
                    ` : ''}

                    ${key === 'doubao' ? `
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="enable-deep-${key}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        <label for="enable-deep-${key}" class="ml-2 text-sm font-medium text-gray-900">å¯ç”¨æ·±åº¦æ€è€ƒ (Deep Think)</label>
                    </div>
                    ` : ''}

                    <div class="mb-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">æ”¯æŒæ¨¡å‹ (è‡ªåŠ¨è·¯ç”±)</label>
                        <input type="text" id="models-${key}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="${(service.models || []).join(', ')}">
                        <p class="text-xs text-gray-500 mt-1">å¤šä¸ªæ¨¡å‹ç”¨é€—å·åˆ†éš”ã€‚</p>
                    </div>
                `;
                container.appendChild(card);
            }
        }

        // --- Help Functions ---
        async function testConnection(key) {
            const statusSpan = document.getElementById(`test-status-${key}`);
            statusSpan.innerHTML = '<span class="animate-pulse text-gray-500">Connecting...</span>';
            
            try {
                const res = await fetch(`/api/test/${key}`);
                const data = await res.json();
                
                if (data.status === 'success') {
                    statusSpan.innerHTML = `<span class="text-green-600 font-bold">âœ“ Connected (HTTP ${data.code})</span>`;
                } else {
                    statusSpan.innerHTML = `<span class="text-red-600 font-bold">âœ— Failed: ${data.message}</span>`;
                }
            } catch (e) {
                statusSpan.innerHTML = `<span class="text-red-600 font-bold">âœ— Error: ${e.message}</span>`;
            }
        }

        function openApiDocs() {
            document.getElementById('api-docs-modal').classList.remove('hidden');
        }

        function closeApiDocs() {
            document.getElementById('api-docs-modal').classList.add('hidden');
        }

        function openHelp(key) {
            const content = helpDocs[key] || 'æš‚æ— è¯¥æœåŠ¡çš„è·å–æŒ‡å—ã€‚';
            const titleMap = {
                deepseek: 'DeepSeek Token è·å–æŒ‡å—',
                glm: 'æ™ºè°± GLM Token è·å–æŒ‡å—',
                kimi: 'Kimi æ™ºèƒ½åŠ©æ‰‹ Token è·å–æŒ‡å—',
                qwen: 'é€šä¹‰åƒé—® Token è·å–æŒ‡å—',
                doubao: 'è±†åŒ… Token è·å–æŒ‡å—',
                yuanbao: 'è…¾è®¯å…ƒå® Token è·å–æŒ‡å—',
                baidu: 'ç™¾åº¦æ–‡å¿ƒä¸€è¨€ Cookie è·å–æŒ‡å—'
            };
            document.getElementById('help-title').innerText = titleMap[key] || 'è·å–æŒ‡å—';
            document.getElementById('help-content').innerHTML = content;
            document.getElementById('help-modal').classList.remove('hidden');
        }

        function closeHelp() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        // --- Account Management Functions ---

        function toggleAddForm(key) {
            const form = document.getElementById(`add-form-${key}`);
            const btn = document.getElementById(`btn-add-${key}`);
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.classList.add('hidden');
            } else {
                form.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }

        function removeAccount(key, index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ')) return;
            
            let accounts = currentConfig[key].token;
            if (!Array.isArray(accounts)) {
                accounts = [accounts];
            }
            
            accounts.splice(index, 1);
            currentConfig[key].token = accounts;
            
            // Clean up legacy fields if yuanbao becomes empty (optional, but good for consistency)
            if (key === 'yuanbao' && accounts.length === 0) {
                 delete currentConfig[key].hy_user;
                 delete currentConfig[key].hy_token;
                 delete currentConfig[key].agent_id;
            }

            renderServices();
        }

        function confirmAddAccount(key) {
            let newAccount = null;

            if (key === 'yuanbao') {
                const hyUser = document.getElementById(`new-hy_user-${key}`).value.trim();
                const hyToken = document.getElementById(`new-hy_token-${key}`).value.trim();
                const agentId = document.getElementById(`new-agent_id-${key}`).value.trim();

                if (!hyUser || !hyToken) {
                    alert('hy_user å’Œ hy_token ä¸èƒ½ä¸ºç©º');
                    return;
                }
                newAccount = {
                    hy_user: hyUser,
                    hy_token: hyToken,
                    agent_id: agentId
                };
            } else if (key === 'doubao') {
                const cookie = document.getElementById(`new-doubao-cookie-${key}`)?.value?.trim() || '';
                const deviceId = document.getElementById(`new-doubao-device_id-${key}`)?.value?.trim() || '';
                const webId = document.getElementById(`new-doubao-web_id-${key}`)?.value?.trim() || '';
                const teaUuid = document.getElementById(`new-doubao-tea_uuid-${key}`)?.value?.trim() || '';
                const xFlowTrace = document.getElementById(`new-doubao-x_flow_trace-${key}`)?.value?.trim() || '';
                if (!cookie) {
                    alert('cookie ä¸èƒ½ä¸ºç©º');
                    return;
                }

                const sessionObj = {};
                sessionObj.cookie = cookie;
                if (deviceId) sessionObj.device_id = deviceId;
                if (webId) sessionObj.web_id = webId;
                if (teaUuid) sessionObj.tea_uuid = teaUuid;
                if (xFlowTrace) sessionObj.x_flow_trace = xFlowTrace;

                const extraContainer = document.getElementById(`doubao-extra-${key}`);
                if (extraContainer) {
                    const rows = extraContainer.querySelectorAll('[data-doubao-extra-row="1"]');
                    rows.forEach(row => {
                        const kEl = row.querySelector('input[data-doubao-extra-key="1"]');
                        const vEl = row.querySelector('input[data-doubao-extra-val="1"]');
                        const k = (kEl?.value || '').trim();
                        const v = (vEl?.value || '').trim();
                        if (k && v) {
                            sessionObj[k] = v;
                        }
                    });
                }

                newAccount = JSON.stringify(sessionObj);
            } else {
                const tokenVal = document.getElementById(`new-token-${key}`).value.trim();
                if (!tokenVal) {
                    alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }
                newAccount = tokenVal;
            }

            // Normalize current token to array
            let currentAccounts = currentConfig[key].token;
            if (!Array.isArray(currentAccounts)) {
                currentAccounts = currentAccounts ? [currentAccounts] : [];
            }
            
            currentAccounts.push(newAccount);
            currentConfig[key].token = currentAccounts;

            // Reset UI
            renderServices();
        }

        function addDoubaoExtraField(key, presetKey = '', presetVal = '') {
            const container = document.getElementById(`doubao-extra-${key}`);
            if (!container) return;

            const row = document.createElement('div');
            row.setAttribute('data-doubao-extra-row', '1');
            row.className = 'flex gap-2 items-center';

            const keyInput = document.createElement('input');
            keyInput.setAttribute('data-doubao-extra-key', '1');
            keyInput.type = 'text';
            keyInput.className = 'flex-1 shadow-sm border rounded py-1 px-2 text-sm font-mono';
            keyInput.placeholder = 'å‚æ•°å (key)';
            keyInput.value = presetKey;

            const valInput = document.createElement('input');
            valInput.setAttribute('data-doubao-extra-val', '1');
            valInput.type = 'text';
            valInput.className = 'flex-1 shadow-sm border rounded py-1 px-2 text-sm font-mono';
            valInput.placeholder = 'å‚æ•°å€¼ (value)';
            valInput.value = presetVal;

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'text-red-500 hover:text-red-700 text-xs font-bold px-2 py-1';
            delBtn.textContent = 'åˆ é™¤';
            delBtn.onclick = () => row.remove();

            row.appendChild(keyInput);
            row.appendChild(valInput);
            row.appendChild(delBtn);
            container.appendChild(row);
        }

        function openYuanbaoLoginForAdd(key) {
            // Re-use existing modal logic but redirect success callback
            currentYuanbaoKey = key; // Mark which service key
            
            // Override the success handler in polling temporarily or handle state
            // Actually, let's modify the existing startYuanbaoPolling to handle "Add Mode"
            // Or simpler: Just populate the "Add" form inputs when scan is done.
            
            // Open modal
            const modal = document.getElementById('yuanbao-modal');
            const qrContainer = document.getElementById('yuanbao-qr-container');
            const statusText = document.getElementById('yuanbao-status');
            
            modal.classList.remove('hidden');
            qrContainer.innerHTML = '<div class="animate-pulse bg-gray-200 w-48 h-48 rounded"></div>';
            statusText.innerText = 'æ­£åœ¨è·å–äºŒç»´ç ...';
            
             fetch('/api/yuanbao/login/qrcode')
                .then(response => response.json())
                .then(data => {
                    if (data.qrcode_url && data.uuid) {
                        qrContainer.innerHTML = `<img src="${data.qrcode_url}" alt="Scan QR Code" class="w-48 h-48 shadow-md rounded">`;
                        statusText.innerText = 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç ';
                        startYuanbaoPolling(data.uuid, true); // true for "isAddMode"
                    } else {
                        statusText.innerText = 'è·å–äºŒç»´ç å¤±è´¥';
                    }
                });
        }
        
        // Modify startYuanbaoPolling to accept isAddMode
        function startYuanbaoPolling(uuid, isAddMode = false) {
             if (yuanbaoPollInterval) clearInterval(yuanbaoPollInterval);
             
             yuanbaoPollInterval = setInterval(() => {
                 fetch(`/api/yuanbao/login/status?uuid=${uuid}`)
                     .then(response => response.json())
                     .then(data => {
                         const statusText = document.getElementById('yuanbao-status');
                         
                         if (data.status === 'success') {
                             clearInterval(yuanbaoPollInterval);
                             statusText.innerText = 'ç™»å½•æˆåŠŸï¼';
                             
                             if (isAddMode && currentYuanbaoKey) {
                                 // Fill the ADD FORM inputs
                                 document.getElementById(`new-hy_user-${currentYuanbaoKey}`).value = data.hy_user || '';
                                 document.getElementById(`new-hy_token-${currentYuanbaoKey}`).value = data.hy_token || '';
                                 document.getElementById(`new-agent_id-${currentYuanbaoKey}`).value = data.agent_id || '';
                             } else if (currentYuanbaoKey) {
                                 // Legacy fill (if we still had the old UI, but we replaced it. 
                                 // Wait, I removed the old UI in renderServices. 
                                 // So this branch might not be needed unless I revert partially.)
                                 // Actually, let's assume we ONLY use the new Add Form for scanning now.
                             }
                             
                             setTimeout(() => closeYuanbaoLogin(), 1000);
                         } else if (data.status === 'scanned') {
                             statusText.innerText = 'å·²æ‰«ç ï¼Œè¯·ç¡®è®¤';
                         } else if (data.status === 'expired') {
                            statusText.innerText = 'å·²è¿‡æœŸ';
                            clearInterval(yuanbaoPollInterval);
                         }
                     });
             }, 1500);
        }

        // --- End Account Management Functions ---

        // --- Chat Functions ---

        function openChatByService(serviceKey) {
            const modelsStr = document.getElementById(`models-${serviceKey}`)?.value || '';
            const firstModel = modelsStr.split(',').map(s => s.trim()).filter(s => s)[0] || '';
            openChat(firstModel);
        }

        function openChat(model) {
            if (!model) {
                alert('è¯¥æœåŠ¡æœªé…ç½®æ¨¡å‹åç§°ï¼Œæ— æ³•å¼€å¯èŠå¤©ã€‚');
                return;
            }
            currentModel = model;
            document.getElementById('chat-title').innerText = `Chat with ${model}`;
            document.getElementById('chat-subtitle').innerText = `æ­£åœ¨ä½¿ç”¨æ¨¡å‹: ${model}`;
            document.getElementById('chat-history').innerHTML = '<div class="text-center text-gray-400 mt-10">å¼€å§‹ä¸ ' + model + ' å¯¹è¯...</div>';
            document.getElementById('chat-modal').classList.remove('hidden');
            document.getElementById('chat-input').focus();
            chatHistory = []; // Reset history
        }

        function closeChat() {
            document.getElementById('chat-modal').classList.add('hidden');
        }

        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            const historyDiv = document.getElementById('chat-history');
            
            // Remove welcome message if exists
            if (chatHistory.length === 0) {
                historyDiv.innerHTML = '';
            }

            // User Message
            appendMessage('user', message);
            chatHistory.push({ role: 'user', content: message });

            // Assistant Placeholder
            const assistantMsgId = 'msg-' + Date.now();
            appendMessage('assistant', '<span class="animate-pulse">...</span>', assistantMsgId);
            
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50');

            try {
                // Find which service this model belongs to
                const serviceKey = Object.keys(currentConfig).find(k => (currentConfig[k].models || []).includes(currentModel));
                const service = currentConfig[serviceKey] || {};

                let headers = { 
                    'Content-Type': 'application/json'
                };
                
                let body = {
                    model: currentModel,
                    messages: chatHistory,
                    stream: true
                };

                if (serviceKey === 'yuanbao') {
                    // Yuanbao specific handling
                    let account = null;
                    if (Array.isArray(service.token) && service.token.length > 0) {
                        account = service.token[Math.floor(Math.random() * service.token.length)];
                    } else if (service.token && typeof service.token === 'object') {
                        account = service.token;
                    }
                    const hyToken = (account && typeof account === 'object' ? (account.hy_token || account.token) : null) || service.hy_token || '';
                    const hyUser = (account && typeof account === 'object' ? (account.hy_user || '') : '') || service.hy_user || '';
                    const agentId = (account && typeof account === 'object' ? (account.agent_id || '') : '') || service.agent_id || 'naQivTmsDa';
                    headers['Authorization'] = 'Bearer ' + hyToken;
                    // Add extra parameters required by Yuanbao proxy
                    // Note: These will be passed as extra_body or directly if the proxy supports it
                    // Assuming the proxy accepts these fields at the root of the JSON body or in extra_body
                    // Standard OpenAI clients use extra_body, but here we are raw fetching
                    body['agent_id'] = agentId;
                    body['hy_user'] = hyUser;
                    body['hy_source'] = 'web';
                } else if (serviceKey === 'kimi') {
                    const token = Array.isArray(service.token) ? (service.token.length ? service.token[Math.floor(Math.random() * service.token.length)] : '') : (service.token || '');
                    headers['Authorization'] = 'Bearer ' + token;
                    // Check for search toggle
                    const enableSearch = document.getElementById(`enable-search-${serviceKey}`)?.checked;
                    if (enableSearch) {
                        // Append -search if not already present
                        if (!body.model.includes('search')) {
                            body.model += '-search';
                        }
                    }
                } else if (serviceKey === 'doubao') {
                    const token = Array.isArray(service.token) ? (service.token.length ? service.token[Math.floor(Math.random() * service.token.length)] : '') : (service.token || '');
                    headers['Authorization'] = 'Bearer ' + token;
                    // Check for deep think toggle
                    const enableDeep = document.getElementById(`enable-deep-${serviceKey}`)?.checked;
                    if (enableDeep) {
                         // Append -deep if not already present
                         if (!body.model.includes('deep')) {
                             body.model += '-deep';
                         }
                    }
                } else {
                    const token = Array.isArray(service.token) ? (service.token.length ? service.token[Math.floor(Math.random() * service.token.length)] : '') : (service.token || '');
                    headers['Authorization'] = 'Bearer ' + token;
                }

                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                const assistantMsgWrapper = document.getElementById(assistantMsgId);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices[0]?.delta?.content || ''; // æµå¼ delta
                                fullContent += content;
                                assistantMsgWrapper.querySelector('.prose').innerHTML = marked.parse(fullContent);
                                historyDiv.scrollTop = historyDiv.scrollHeight;
                            } catch (e) {
                                // å¦‚æœè§£æ JSON å¤±è´¥ï¼ˆæ¯”å¦‚æ˜¯æ™®é€šæ–‡æœ¬å“åº”ï¼‰ï¼Œå°è¯•ç›´æ¥æ˜¾ç¤º
                                // é’ˆå¯¹ Python Doubao éæµå¼çš„æƒ…å†µ
                                if (!fullContent && data.includes('"content":')) {
                                    // å°è¯•ä½œä¸ºéæµå¼å¤„ç†
                                    try {
                                         const json = JSON.parse(data);
                                         if (json.choices && json.choices[0].message) {
                                             fullContent = json.choices[0].message.content;
                                             assistantMsgWrapper.querySelector('.prose').innerHTML = marked.parse(fullContent);
                                         }
                                    } catch(e2) {}
                                }
                            }
                        } 
                        // å¤„ç†é SSE å“åº” (æ™®é€š JSON)
                        else if (line.trim().startsWith('{') && !fullContent) {
                            try {
                                const json = JSON.parse(line);
                                if (json.error) {
                                     // Handle explicit error in JSON
                                     fullContent = `**Error:** ${typeof json.error === 'string' ? json.error : JSON.stringify(json.error)}`;
                                     assistantMsgWrapper.querySelector('.prose').innerHTML = marked.parse(fullContent);
                                     historyDiv.scrollTop = historyDiv.scrollHeight;
                                } else if (json.choices && json.choices[0].message) {
                                    fullContent = json.choices[0].message.content;
                                    assistantMsgWrapper.querySelector('.prose').innerHTML = marked.parse(fullContent);
                                    historyDiv.scrollTop = historyDiv.scrollHeight;
                                }
                            } catch (e) {}
                        }
                    }
                }
                
                chatHistory.push({ role: 'assistant', content: fullContent });

            } catch (error) {
                console.error('Chat error:', error);
                document.getElementById(assistantMsgId).querySelector('.prose').innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50');
                document.getElementById('chat-input').focus();
            }
        }

        function appendMessage(role, content, id = null) {
            const historyDiv = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            if (id) div.id = id;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] rounded-lg px-4 py-2 ${
                role === 'user' 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-white border border-gray-200 text-gray-800'
            }`;
            
            if (role === 'assistant') {
                bubble.innerHTML = `<div class="prose prose-sm max-w-none">${content}</div>`;
            } else {
                bubble.textContent = content;
            }
            
            div.appendChild(bubble);
            historyDiv.appendChild(div);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        // --- End Chat Functions ---

        async function saveConfig() {
            // Re-sync UI state to currentConfig before saving (though UI actions usually update currentConfig directly)
            // Actually, removeAccount/confirmAddAccount already update currentConfig.
            // But 'models' input is still separate, so we must sync models.
            
            for (const key of Object.keys(currentConfig)) {
                const modelsStr = document.getElementById(`models-${key}`).value;
                currentConfig[key].models = modelsStr.split(',').map(s => s.trim()).filter(s => s);
                
                // Smart Save: If "Add Token" textarea has content but user forgot to click "Confirm Add",
                // AND there are no other tokens, we auto-add it.
                if (key !== 'yuanbao') { // Yuanbao uses complex form, safer to skip auto-add or handle carefully
                    const tokenInput = document.getElementById(`new-token-${key}`);
                    if (tokenInput && tokenInput.value.trim()) {
                        const val = tokenInput.value.trim();
                        // Check if accounts list is empty or user likely intends to add this
                        let currentAccounts = currentConfig[key].token;
                        if (!Array.isArray(currentAccounts)) {
                            currentAccounts = currentAccounts ? [currentAccounts] : [];
                        }
                        
                        // If empty, definitely add. If not empty, maybe warn? 
                        // Let's just add it if it's not already in the list (simple check)
                        if (!currentAccounts.includes(val)) {
                             currentAccounts.push(val);
                             currentConfig[key].token = currentAccounts;
                             // Clear input to indicate it was consumed
                             tokenInput.value = ''; 
                        }
                    }
                }
            }

            console.log('Saving config:', JSON.stringify(currentConfig, null, 2));

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentConfig)
                });
                
                if (res.ok) {
                    // Re-render to show any auto-added tokens
                    renderServices();
                    alert('é…ç½®ä¿å­˜æˆåŠŸï¼å³æ—¶ç”Ÿæ•ˆã€‚');
                } else {
                    const errorText = await res.text();
                    let detail = errorText;
                    try {
                        const parsed = JSON.parse(errorText);
                        detail = parsed?.detail || errorText;
                    } catch (e) {}
                    alert(`ä¿å­˜å¤±è´¥: ${detail || ('HTTP ' + res.status)}`);
                }
            } catch (e) {
                alert('ä¿å­˜å‡ºé”™: ' + e);
            }
        }

        loadConfig();
    </script>
</body>
</html>
